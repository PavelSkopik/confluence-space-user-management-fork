## Copyright (c) 2006, Rajendra Kadam
## All rights reserved.
##
## Redistribution and use in source and binary forms, with or without
## modification, are permitted provided that the following conditions are
## met:
##
## Redistributions of source code must retain the above copyright notice,
## this list of conditions and the following disclaimer.  Redistributions
## in binary form must reproduce the above copyright notice, this list of
## conditions and the following disclaimer in the documentation and/or
## other materials provided with the distribution.  Neither the name of
## Cenqua Pty Ltd nor the names of its contributors may be used to
## endorse or promote products derived from this software without
## specific prior written permission.
##
## THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
## "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
## LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
## A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
## OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
## SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
## LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
## DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
## THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
## (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
## OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

    <!-- start configure-plugin -->
	<head>
        <title>$action.getActionName($action.getClass().getName())</title>
	</head>
	<body>
		<script language="javascript">
		
            function toggleJiraSettingsInput(e)
            {
                //If User Management delegated to jira then only ask user for jira URL and Jira JNDI values
                if (e.value == 'JIRA')
                {
                    document.getElementById('jiraJNDILookupKey').disabled = false;
                }
                else
                {
                    document.getElementById('jiraJNDILookupKey').disabled = true;
                    document.getElementById('jiraJNDILookupKey').value = '';
                }
            }
            
            function toggleGroupSettingsInput(e)
            {
                //If User Management delegated to jira then only ask user for jira URL and Jira JNDI values
                if (e.value == 'YES')
                {
                    document.getElementById('newGroupNameCreationPrefixPattern').disabled = false;
                    document.getElementById('newGroupNameCreationSuffixPattern').disabled = false;
                }
                else
                {
                    document.getElementById('newGroupNameCreationPrefixPattern').disabled = true;
                    document.getElementById('newGroupNameCreationPrefixPattern').value = '';
                    document.getElementById('newGroupNameCreationSuffixPattern').disabled = true;
                    document.getElementById('newGroupNameCreationSuffixPattern').value = '';
                }
            }

            function toggleLDAPSettingsInput(e)
		    {
		    	//if LDAP is used for Authentication, then get LDAP settings for user creation
		        if (e.value == 'YES')
		        {
		            document.getElementById('companyLDAPUrl').disabled = false;
		            document.getElementById('companyLDAPBaseDN').disabled = false;
		        }
		        else
		        {
		            document.getElementById('companyLDAPUrl').disabled = true;
		            document.getElementById('companyLDAPUrl').value = '';
		            		       
		            document.getElementById('companyLDAPBaseDN').disabled = true;
		            document.getElementById('companyLDAPBaseDN').value = ''
		        }
		    }
		
		</script>

		#parse ( "/template/includes/actionerrors.vm" )
       <!-- Display result of operation if successful -->
		#parse ( "/templates/permissionmgmt/action-messages.vm" )

        <table class="grid" width="80%">
        <tr>
            <td class="label" bgcolor="#f0f0f0" width="100%" colspan="2">Current Settings for Custom Space User Management Plugin:</td>
        </tr>
        <tr>
            <td class="label" width="30%">User Manager Location for Wiki:</td>
            <td nowrap>
                #if ($!action.customPermissionConfiguration.userManagerLocation)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.userManagerLocation</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>
        <tr>
            <td class="label" width="30%">Jira JNDI Datasource:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.jiraJNDILookupKey)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.jiraJNDILookupKey</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>                        
        <tr>
            <td class="label" width="30%">LDAP Authentication Used?:</td>
            <td nowrap>
                    <span style="color: green; font-weight: bold">#if ($!action.customPermissionConfiguration.ldapAuthUsed == "YES") YES #else NO #end</span>
            </td>
        </tr>
        <tr>
            <td class="label" width="30%">LDAP Url:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.companyLDAPUrl)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.companyLDAPUrl</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>
        <tr>
            <td class="label" width="30%">LDAP Search Base DN:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.companyLDAPBaseDN)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.companyLDAPBaseDN</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>

        <tr>
            <td class="label" width="30%">Usergroups Matching Pattern:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.userGroupsMatchingPattern)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.userGroupsMatchingPattern</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>

        <tr>
            <td class="label" width="30%">Group Actions Permitted:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.groupActionsPermitted)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.groupActionsPermitted</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>

        <tr>
            <td class="label" width="30%">New Group Name Creation Pattern:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.newGroupNameCreationPrefixPattern)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.newGroupNameCreationPrefixPattern</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end

                &nbsp;(group identifier)&nbsp;

                #if ($action.customPermissionConfiguration.newGroupNameCreationSuffixPattern)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.newGroupNameCreationSuffixPattern</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>

        <tr>
            <td class="label" width="30%">Max UserId/GroupId Limit:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.maxUserIDsLimit)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.maxUserIDsLimit</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>

        <tr>
            <td class="label" width="30%">Plugin Deactivated:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.pluginDown)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.pluginDown</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>
        
        <tr>
            <td class="label" width="30%">Plugin Downtime Message:</td>
            <td nowrap>
                #if ($action.customPermissionConfiguration.downTimeMessage)
                    <span style="color: green; font-weight: bold">$!action.customPermissionConfiguration.downTimeMessage</span>
                #else
                    <span style="color: #900; font-weight: bold">-</span>
                #end
            </td>
        </tr>
        
        <tr>
            <td colspan="2">&nbsp;</td>
        </tr>
        <tr>
            <td class="label" bgcolor="#f0f0f0" width="100%" colspan="2">Update Settings for Custom Space User Management Module:</td>
        </tr>

       <form action="doconfig.action" method="POST" name="CustomUserManagementConfigForm">
        <tr>
            <td valign="top" class="label" width="30%">User Manager Location:</td>
            <td>
				#fielderror ('userManagerLocation')
                <input type="radio" name="userManagerLocation" value="CONFLUENCE" #if ($action.userManagerLocation == "CONFLUENCE") checked="true" #end  onclick="toggleJiraSettingsInput(this)" />CONFLUENCE &nbsp;
                <input type="radio" name="userManagerLocation" value="JIRA" #if ($action.userManagerLocation == "JIRA") checked="true" #end onclick="toggleJiraSettingsInput(this)" />JIRA
                <br>
                <font size="1">
            	Notes:
            	<ul>
            	  <li>If you are using LDAP for user management, then please select option <b>CONFLUENCE</b>.</li>
            	  <li>If you are using <b>JIRA</b> for user management, please define a properties file called
            	      <b>$action.jiraPropertiesFilename</b> and copy that file somewhere into the classpath of each
            	      Confluence server using this plugin; the contents of this file should look like the following
            	      (<b>change values in the file to match your environment</b>):</li>
                </ul>
                </font>
<div class="preformatted"><div class="preformattedContent">
<pre>${action.propertyNameForJiraSoapUrl}=http://yourhostname/rpc/soap/jirasoapservice-v2
${action.propertyNameForJiraSoapUsername}=yourjiraadminusername
${action.propertyNameForJiraSoapPassword}=yourjiraadminpassword
</pre>
</div></div>
            </td>
        </tr>

        <tr>
            <td valign="top" class="label" width="30%">Jira JNDI Datasource:</td>
            <td>
				#fielderror ('jiraJNDILookupKey')
                <input type="text" name="jiraJNDILookupKey" id="jiraJNDILookupKey" value="$!action.jiraJNDILookupKey" #if ($action.userManagerLocation == "CONFLUENCE") disabled="true" #end size="50" />
                <p>
                    Enter Jira Datasource name that is being used during <b>Confluence and Jira Integration</b> as explained <a href="http://confluence.atlassian.com/display/DOC/How+to+delegate+user+management+in+Confluence+to+JIRA#HowtodelegateusermanagementinConfluencetoJIRA-2.SetupdatasourcetoJIRAuserbasewithinConfluence">here</a> &nbsp; <font size="1">Example: jdbc/JiraDS</font>
                </p>
            </td>
        </tr>

        <tr>
            <td valign="top" class="label" width="30%">Max UserIDs Limit:</td>
            <td>
                <input type="text" name="maxUserIDsLimit" value="$!action.maxUserIDsLimit" size="2" />
                <p>
                    <font size="1">If this value is not defined, then default max UserIDs limit is 20.</font>
                </p>
            </td>
        </tr>
        
        <tr>
            <td valign="top" class="label" width="30%">Usergroups Matching Pattern:</td>
            <td>
                <input type="text" name="userGroupsMatchingPattern" value="$!action.userGroupsMatchingPattern" size="30" />
                <p>
                    <font size="1">
                    This pattern is just a
                    <a href="http://java.sun.com/j2se/1.4.2/docs/api/java/util/regex/Pattern.html">
                    Java regular expression pattern</a> with the exception that the text <b>SPACEKEY</b>
                    is replaced by the key of the selected Wiki space at runtime.
                    </font>
                </p>
                <p>
                    <font size="1">
                	e.g.: If SPACEKEY is "ds", then pattern <b>SPACEKEY-.*</b> will match ds-users, ds-conf-users<br>
                    </font>
                </p>
            </td>
        </tr>

        <tr>
            <td valign="top" class="label" width="30%">Group Actions Permitted:</td>
            <td>
				#fielderror ('groupActionsPermitted')
                <input type="radio" name="groupActionsPermitted" value="YES" #if ($!action.groupActionsPermitted == "YES") checked="true" #end onclick="toggleGroupSettingsInput(this)" />YES &nbsp;
                <input type="radio" name="groupActionsPermitted" value="NO" #if ($!action.groupActionsPermitted == "NO") checked="true" #end onclick="toggleGroupSettingsInput(this)" />NO
                <p>
                    <font size="1">
                	This enables the ability to add/remove groups whose name matches the pattern specified above, effectively enabling the ability to have space-specific groups manageable by space administrators.
                    </font>
                </p>
            </td>
        </tr>

        <tr>
            <td valign="top" class="label" width="30%">New Group Name Creation Pattern:</td>
            <td>
                <!-- TODO: Cleanup ugly table and CSS. -->
				<table style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				    <tr style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				        <td style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				            #fielderror ('newGroupNameCreationPrefixPattern')
				        </td>
				        <td style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				            &nbsp;
				        </td>
				        <td style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				            #fielderror ('newGroupNameCreationSuffixPattern')
				        </td>
				    </tr>
				    <tr style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				        <td style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				            <input type="text" name="newGroupNameCreationPrefixPattern" id="newGroupNameCreationPrefixPattern" value="$!action.newGroupNameCreationPrefixPattern" #if ($action.groupActionsPermitted == "NO") disabled="true" #end size="50" />
				        </td>
				        <td style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				            &nbsp;(group identifier)&nbsp;
				        </td>
				        <td style="border-width: 0px 0px 0px 0px; border-spacing: 0px;	border-style: none none none none; border-collapse: separate;">
				            <input type="text" name="newGroupNameCreationSuffixPattern" id="newGroupNameCreationSuffixPattern" value="$!action.newGroupNameCreationSuffixPattern" #if ($action.groupActionsPermitted == "NO") disabled="true" #end size="50" />
				        </td>
				    </tr>
				</table>
                <p>
                    <font size="1">
                    Anywhere that SPACEKEY occurs within the prefix or suffix is replaced by the key of the
                    selected Wiki space at runtime. The prefix and suffix are NOT regular expressions.
                    </font>
                </p>
                <p>
                    <font size="1">
                    Examples: If prefix <b>SPACEKEY-</b> and no suffix are specified, and SPACEKEY is "tst", then only
                	groups that start with <b>tst-</b> can be created like "tst-apples" and "tst-oranges".<br/>
                	If prefix <b>sa.</b> and suffix <b>.SPACEKEY</b> are specified, and SPACEKEY is "tst", then only
                	groups that start with <b>sa.</b> and end in <b>.tst</b> can be created like "sa.apples.tst" and
                	"sa.oranges.tst".
                	</font>
                </p>
            </td>
        </tr>
        
        <tr>     
            <td valign="top" class="label" width="30%">Use LDAP for User Authentication:</td>
            <td>
				#fielderror ('ldapAuthUsed')
                <input type="radio" name="ldapAuthUsed" value="YES" #if ($!action.ldapAuthUsed == "YES") checked="true" #end onclick="toggleLDAPSettingsInput(this)" />YES &nbsp;
                <input type="radio" name="ldapAuthUsed" value="NO" #if ($!action.ldapAuthUsed == "NO") checked="true" #end onclick="toggleLDAPSettingsInput(this)" />NO
            </td>
        </tr>        
        
        <tr>
            <td valign="top" class="label" width="30%">LDAP Url:</td>
            <td>
				#fielderror ('companyLDAPUrl')
                 <input type="text" name="companyLDAPUrl" id="companyLDAPUrl" value="$!action.companyLDAPUrl" #if ($!action.ldapAuthUsed == "NO") disabled="true" #end size="50" />
					<br>
	            	<font size="1">Example: ldap://acme:389</font>                 
            </td>
        </tr>

        <tr>
            <td valign="top" class="label" width="30%">LDAP Search Base DN:</td>
            <td>
				#fielderror ('companyLDAPBaseDN')
                 <input type="text" name="companyLDAPBaseDN" id="companyLDAPBaseDN" value="$!action.companyLDAPBaseDN" #if ($!action.ldapAuthUsed == "NO") disabled="true" #end size="50" />
					<br>
	            	<font size="1">Example: dc=acme,dc=com</font>                 
            </td>
        </tr>
        
        <tr>     
            <td valign="top" class="label" width="30%">Plugin Deactivated:</td>
            <td>
                <input type="radio" name="pluginDown" value="YES" #if ($!action.pluginDown == "YES") checked="true" #end />YES &nbsp;
                <input type="radio" name="pluginDown" value="NO" #if ($!action.pluginDown == "NO") checked="true" #end />NO
            </td>
        </tr>

        <tr>
            <td valign="top" class="label" width="30%">Plugin Downtime Message:</td>
            <td>
   	         <textarea name="downTimeMessage" cols="60" rows="6" class="monospaceInput">$!action.downTimeMessage</textarea>
            </td>
        </tr>
        
        <tr>
            <td class="label" width="100%" colspan="2">
                    <input type="submit" value="Update" />
					<input id="cancelButton"  type="button" 
					       name="Home of Admin Console"
					       value="Cancel"
					       onclick="location.href='$req.contextPath/admin/console.action'" />
            </td>
        </tr>
        
        <!--
		<tr >
			<td colspan="2" bgcolor="ffffff" nowrap class="fieldValueArea">
				<font size="1">
					<b>Note: Right now there is no validation done to make sure entered values are correct!</b>
				</font>
			</td>
		</tr>
		-->
       </form>
     </table>


		#parse ( "/admin/admin-breadcrumbs.vm" )
	</body>
</html>

<!-- end configure-plugin -->
