## Copyright (c) 2006, Rajendra Kadam
## All rights reserved.
##
## Redistribution and use in source and binary forms, with or without
## modification, are permitted provided that the following conditions are
## met:
##
## Redistributions of source code must retain the above copyright notice,
## this list of conditions and the following disclaimer.  Redistributions
## in binary form must reproduce the above copyright notice, this list of
## conditions and the following disclaimer in the documentation and/or
## other materials provided with the distribution.  Neither the name of
## Cenqua Pty Ltd nor the names of its contributors may be used to
## endorse or promote products derived from this software without
## specific prior written permission.
##
## THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
## "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
## LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
## A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
## OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
## SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
## LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
## DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
## THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
## (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
## OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

<html>
    <head>
        <title>$action.getActionName($action.getClass().getName())</title>
    </head>

    #applyDecorator("root")
        #decoratorParam("helper" $action.helper)
        #decoratorParam("context" "space-custom-usermanagement") ##note this should be same as item.key defined in atlassian-plugin.xml
        #decoratorParam("mode" "view-edit-spaceusergroups")
        
            <content tag="spacekey">$action.space.key</content>
            #set( $contextPath = "/customspacemgmt/permissions/custompermissionsmanage.action?key=${key}&" )

    <body>
    <!--
    <style>
        form {margin:0; padding:0;}
        fieldset {border:none; padding:0; margin:0;}
        input {margin:0; padding:0; font-size:1.5em; width:100%;}
        label {font-size:1.4em; display:block;}

        div#PageContent {padding:0;}

        div#csumHeader {margin:0;}

        div#csumGroups {padding:0 1em; width:300px; float:left; margin:0; border-right:1px solid orange;}
        div#csumGroups h3 {margin:0 0 10px 0;}
        div#csumGroups ul {margin:0; padding:0;}
        div#csumGroups ul li {padding:0 3px; list-style: none inside url(/confluence/images/icons/group_16.gif);}
        div#csumGroups ul li a {display:block; line-height:1; padding:.4em .3em; font-size:1.2em; text-decoration:none; border-top:1px dotted #FFF; border-bottom:1px dotted #FFF;}
        div#csumGroups ul li a:hover {background-color:#EEE; border-top:1px dotted #CCC; border-bottom:1px dotted #CCC;}

        div#csumGroupEditor {padding:0 1em;}

        .submitBttn {width:auto; margin:0 .3em;}
        #groupToAdd {width:220px;}
    </style>
    -->
		<script language="javascript">
			
			//If user has selected, "confluence-users" button then we want to disable Removebutton.
			//Because removing users from this default group will prevent them from logging into Confluence Wiki!			
		    function toggleRemoveButtonState(e)
		    {
		        if (e.checked == true)
		        {
		            document.getElementById('RemoveFromGroups').disabled = true;
		        }
		        else if (e.checked == false)
		        {
		            document.getElementById('RemoveFromGroups').disabled = false;
		        }
		    }
		    
		    function goToOtherWikis()
		    {	
		    	var selectedWikiSpaceKey = document.getElementById('allowedWikiSpacesId').value;
				location.href='$req.contextPath/customspacemgmt/permissions/custompermissionsmanage.action?key=' + selectedWikiSpaceKey;
		    }
		</script>

#parse ( "/templates/permissionmgmt/actionmessages.vm" )

    #if($isPluginConfigurationDone)

    <table border="0" width="100%" cellpadding="5" cellspacing="0">
    <tr><td width="165" valign="top">
        <div class="navmenu">
            <div class="menuheading">Groups in Space '$action.space.key'</div>        
            ##<h3>$action.space.name ($action.space.key)</h3>
            #set ($groups = $action.groups)

            #if($isGroupActionsPermitted)

		    <form method="POST" action="docustompermissionsmanage.action?key=${key}" id="groupManagement" name="AddGroupForm">
                <input type="hidden" name="adminAction" value="addGroup"/>
                <input type="text" name="groupToAdd" id="groupToAdd" />
                <input type="submit" value="Add Group"/>
                <br/><span class="smalltext">Entering "widget" will create the group "${action.newGroupPrefix}widget${action.newGroupSuffix}"</span>
            </form>
            #end

            #if($groups && $groups.size() > 0 )
            <table width="100%">
                #foreach ($group in $groups)
                <tr style=" #if ($velocityCount % 2 == 0) background: #f0f0f0; #end">
                    <td>
                        &nbsp;
                        <a href="docustompermissionsmanage.action?key=${key}&selectedGroup=$group.name"><img src="/images/icons/group_16.gif" width="16" height="16" border="0" align="absmiddle"></a>
                        <a href="docustompermissionsmanage.action?key=${key}&selectedGroup=$group.name">$!group.name</a>
                    </td>
                    #if($isGroupActionsPermitted)
                    <td>
                        <a href="docustompermissionsmanage.action?key=${key}&adminAction=removeGroup&groupToRemove=$!group.name">
                            <img border="0" alt="Remove $!group.name" src="/images/icons/trash_16.gif"/>
                        </a>
                    </td>
                    #end
                </tr>
                #end
            </table>
            <br/>
                #if($isGroupActionsPermitted)

                <div class="menuheading">Security</div>
                <div class="menuitems">
                    <div class="optionPadded">
                        <a href="/spaces/spacepermissions.action?key=ds"><img src="/images/icons/lock_16.gif" height="16" width="16" border="0" align="absmiddle" title="Permissions"></a>
                        <a href="/spaces/spacepermissions.action?key=ds">Permissions</a>
                    </div>
                    <div class="optionPadded">
                        <a href="/pages/listpermissionpages.action?key=ds"><img src="/images/icons/locked_pages_16.gif" height="16" width="16" border="0" align="absmiddle" title="Restricted Pages"></a>
                        <a href="/pages/listpermissionpages.action?key=ds">Restricted Pages</a>
                    </div>
                </div>

            <a href="/spaces/spacepermissions.action?key=${key}">Space</a>,
            <a href="/pages/listpermissionpages.action?key=${key}">Page-Level</a>
                #end
            #end
        </div>

    </td>
    <td valign="top">
        
        #if(${action.selectedGroup})
		    <h3>Users in Group '${action.selectedGroup}'</h3>

		    #set ($users = $action.findUsers(${action.selectedGroup}))

		    <form method="POST" action="docustompermissionsmanage.action?key=${key}&selectedGroup=${action.selectedGroup}" id="groupManagement" name="ManageUsersForm">
                <table>
                    <tr>
                        <td align="right">
                            <input type="hidden" name="adminAction" value="addUsersToGroup"/>
                            <input type="text" id="usersToAdd" name="usersToAdd"/>
                        </td>
                        <td align="left">
                            <input type="submit" value="Add User(s) to Group"/>
                        </td>
                    </tr>
                    <tr><td><span class="smalltext">eg. rb04, nk93, kb85, ts69</span></td></tr>
                </table>
            </form>

            #if($users && $users.size() > 0)
                <table width="100%">
                    <tr>
                        <th class="permissionSuperTab">Full Name</th>
                        <th class="permissionSuperTab">NetID</th>
                        <th class="permissionSuperTab">Email</th>
                        <th class="permissionHeading">&nbsp;</th>
                    </tr>
                #foreach ($user in $users)
                    #set ($userFullName = $user.getFullName())
                    #set ($userName = $user.getName())
                    #set ($userEmail = $user.getEmail())
                    <tr style=" #if ($velocityCount % 2 == 0) background: #f0f0f0; #end">
                        <td><img src="/images/icons/user_16.gif" width="16" height="16" border="0" align="absmiddle">&nbsp;$!userFullName</td>
                        <td align="left" class="permissionCell" valign="top">$!userName</td>
                        <td align="left" class="permissionCell" valign="top">$!userEmail</td>
                        <td align="left" class="permissionCell" valign="top"><a href="docustompermissionsmanage.action?key=${key}&selectedGroup=${action.selectedGroup}&adminAction=removeUsersFromGroup&usersToRemove=$!userName"><img border="0" alt="Remove $!userName from ${action.selectedGroup}" src="/images/icons/trash_16.gif"/></a></td>
                    </tr>
                #end
                </table>
                <p>
                Manage User Permissions:
                <a href="/spaces/spacepermissions.action?key=${key}">Space</a>,
                <a href="/pages/listpermissionpages.action?key=${key}">Page-Level</a>
                </p>
            #else
                No users found in group.
            #end
        #end
    #else
        #if($customPermissionConfiguration.pluginDown == "yes")
            $customPermissionConfiguration.downTimeMessage
		#else
		    <p>An administrator must configure "Custom Space Usergroups Manager" before you start using it.</p>
		#end
    #end

#parse ( "/admin/admin-breadcrumbs.vm" )
    </td></tr>
    </table>

    <div style="clear:both;"></div>

</body>
#end
</html>

#*
    <!-- actionerrors.vm is already included by space.vmd, hence it's not needed to add it here. -->
    <!-- Display result of operation if successful -->
    #parse ( "/templates/permissionmgmt/actionmessages.vm" )

    <div id="csumHeader">
        <h2>Manage users/user groups for $action.space.name ( $action.space.key )</h2>
        #if ($)
             <a id="adminConfigLink" href="$req.contextPath/permissionHelper.isGlobalAdministrator($remoteUser)admin/plugins/custompermissionsconfig/config.action">Configure Custom Space Usergroups Manager Plugin</a>
        #end
    </div>

	#if($isPluginConfigurationDone)
	    #set ($groups = $action.UsersGroupsAssociatedForSpace)

        <div id="groupslist" style="width:300px; float:left; margin:1em; border:1px solid green;">
            #fielderror ('groups_')
            #if ($groups.size() > 0)
            <ul>
                #foreach ($group in $groups)
                <li>
                    $group.name ($action.findUserCountForUserGroup($group.name))
                    #if($!group.name == "confluence-users")
                        <!--we do not want to display list of confluence-users as they can be too many-->
                    #else
                    <!--<a href="docustompermissionsmanage.action?key=$action.space.key&selectedGroupName=$group.name" onClick="window.open(this.href,'users_group_association_window', 'width=620, height=800, resizable, scrollbars'); return false;" title="Users 'n Group  association">view users</a> -->
                    <span class="logoSpaceLink">
                        <a href="#" onClick="picker=window.open('custompermissionsusergroupsdisplay.action?key=$action.space.key&selectedGroupName=$group.name', 'UsersNamesDisplayer',  'status=yes,resizable=yes,top=100,left=200,width=580,height=550,scrollbars=yes'); picker.focus(); return false;">view users</a>
                    </span>
                    #end
                </li>
                #end
            </ul>
            <form method="POST" action="docustompermissionsmanage.action?key=${key}" id="groupManagement" name="ManageUsersForm">
                #if ($action.customPermissionConfiguration.groupActionsPermitted == "YES")
                <fieldset>
                    ##input groupslist
                    #fielderror ('groupsToAdd')
                    <label>Input Group IDs:</label>
                    <input type="text" id="groups" name="groupsToAdd" value="$!action.groupsToAdd" />
                    <!--
                    <span class="fieldExample">Comma separated list of groupnames for addition. Eg. editors</span>
                    <span class="fieldNotes">Only <b>$action.maxUserIDsLimit</b> groupids will be processed at a time.</span>
                    !-->
                </fieldset>
                #end
            </form>
        </div>

        <div id="userlist" style="margin:1em; width:500px; float:left; border:1px solid orange;">
        #if ($action.selectedGroupName != null)
            <fieldset>
                #fielderror ('NotPermittedUserGroupsErrorMessage')
                ##input userlist
                #fielderror ('users')
                <label>Input User IDs:</label>
                <input type="text" id="users" name="users" value="$!action.users" />
                <span class="fieldExample">Comma separated list of userids. Eg. ptusha,sachin,marykomb</span>
                <span class="fieldNotes">Only <b>$action.maxUserIDsLimit</b> userids will be processed at a time.</span>
            </fieldset>

            #set ($group_name = $action.selectedGroupName)
            <h4>Group $action.selectedGroupName details ($action.findUserCountForUserGroup($group_name) users)</h4>
            #if ($group_name == "confluence-users")
                -All Users In Confluence Wiki-
            #else
                #set ($users = $action.findUserDetailsForAGroup($group_name))
                #if( $users.size() > 0)
                <ul>
                    #foreach($user in $users)
                    <li>
                     <a href="$req.contextPath/display/~$generalUtil.doubleUrlEncode($user.name)">$generalUtil.htmlEncode($user.fullName)</a> <span class="smalltext">($user.name)</span><br>
                             <span class="smalltext">$generalUtil.maskEmail($user.email)</span>
                    </li>
                    #end
                </ul>
                #end
            #end
        #end
        </div>



<div style="clear:both;">
        Select an Action ->
        #fielderror ('adminAction')
        <input type="radio" name="adminAction" #if ($action.adminAction == "AddToGroups") checked="true" #end value="AddToGroups"> Add Users to Selected Groups<b>*</b> &nbsp;
        <!-- Remove button will be disabled if user has pre-selected "confluence-users" user group! -->
        <input type="radio" name="adminAction" id="RemoveFromGroups" #if ($action.adminAction == "RemoveFromGroups") checked="true" #end #if($action.isGroupSelected("confluence-users")) disabled #end value="RemoveFromGroups"> Remove Users from Selected Groups<b>**</b>
            #if ($action.customPermissionConfiguration.groupActionsPermitted == "YES")
                <input type="radio" name="adminAction" #if ($action.adminAction == "AddGroups") checked="true" #end value="AddGroups"> Add New Groups &nbsp;
                <input type="radio" name="adminAction" #if ($action.adminAction == "RemoveGroups") checked="true" #end value="RemoveGroups"> Remove Groups &nbsp;
            #end
</div>
        <div class="submit">
            <fieldset style="clear:both;">
                <input type="submit" name="Process" value="Process" accesskey="S" />
                <input id="cancelButton"  type="button"
                       accesskey="`"
                       title="Cancel (Alt + `)"
                       name="Go to Space Home Page"
                       value="Cancel"
                       onclick="location.href='$req.contextPath/display/${key}'"
                 />
             </fieldset>
            *  - New users will be added to Wiki provided Confluence Administrator has enabled LDAP Settings.<br/>
            ** - users can not be removed from default user group "confluence-users". Hence upon selection of this group, "Remove..." option will be disabled
        </div>


        </form>


        #else
        <div>
        You can not manage user-groups associated with this wiki space. Please check with Confluence Administrators.</font>
        </div>
     #end

    #set ($wikispaces = $action.spacesAsSpaceAdminForUser)

	#if($wikispaces.size() > 0)
		<form method="GET" action="custompermissionsmanage.action" name="ManageOtherWikiSpacesForm">
            <label>Do you want to manage users for other Wiki spaces?</label>
            <select id="allowedWikiSpacesId" name="allowedWikiSpaces">
                #foreach ($wikispace in $wikispaces)
                    <option value="$wikispace.key" #if($wikispace.key == $action.space.key) selected #end >$wikispace.name ($wikispace.key)</option>
                #end
            </select>
            <input type="button" name="ManageOtherWikis" value="Manage Other Wikis" onclick="goToOtherWikis()" />
		</form>
    #end

    #else
        #if($customPermissionConfiguration.pluginDown == "yes")
            $customPermissionConfiguration.downTimeMessage
		#else
		    <h4>An administrator must configure "Custom Space Usergroups Manager" before you start using it.</h4>
		#end

		#if ($permissionHelper.isGlobalAdministrator($remoteUser))
		    <a href="$req.contextPath/admin/plugins/custompermissionsconfig/config.action">Configure "Custom Space Usergroups Manager" Plugin</a>
		#end
	#end
*#


